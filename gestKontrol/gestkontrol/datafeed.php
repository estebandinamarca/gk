<?php//include_once("dbconfig.php");//include_once("functions.php");//require_once ('dbconfig.php');require_once ('src/classes/usuario.php');
require_once ('src/classes/controlUsuario.class.php');
session_start();
if(!isset($_SESSION["usuario_gk"]))  header("Location: login.php");$usuario = $_SESSION["usuario_gk"];//print_r();require_once ('functions.php');require_once 'src/classes/controlReserva.class.php';require_once ('src/classes/controlVisita.class.php');date_default_timezone_set('America/Santiago');function addCalendar($st, $et, $sub, $ade){  $ret = array();      $ret['IsSuccess'] = true;      $ret['Msg'] = 'add success';      $ret['Data'] =rand();      //echo $st."__".$et."__".$sub."__".$ade;  return $ret;}function addDetailedCalendar($idc,$st,$et,$nombre,$apellido,$mail,$pisos,$oficina,$patente,$esta,$idvP){  $ret = array();      $ret['IsSuccess'] = true;      /*        *$idc,date_format($st,"y-m-d H:i"),date_format($et,"y-m-d H:i"),$_POST["Nombre"],$_POST["Apellido"],$_POST["Mail"],$_POST["pisoss"],$_POST["oficinass"],$_POST["p"],$_POST["estacioReservaCalendar"]       *       *insertVisitaYretId(dato[],idCliente)       *      * inserta datos de la visita: (dato[],idCliente) -- rut,dv,pasaporte,nombre,apellido,direccion,telefono,rubro,contacto,servicio,tipoVisita,empresa      *      * insertaReserva(dato)      *      * inserta datos reserva: $dato[]      * idCliente,idOperador,idVisita,fechaEntrada,fechaSalida,tipoReserva,tipoFrecuencia,piso,oficina,estacionamientoAsignado,estadoValidacion,momentoValidacion,codigoReserva,patenteVehiculo      *      */      //print_r($idc."_".$st."_".$et."_".$nombre."_".$apellido."_".$mail."_".$pisos."_".$oficina."_".$patente."_".$esta);      //die();      $dataVisita = array(null,null,null,$nombre,$apellido,null,null,null,$mail,null,"normal",null);            $idVisitanew = null;      $dataReserva = null;      $tipoReserva = "Peatonal"; //Vehicular // S/P      $estacio = null;      //$idVisitanew = controlVisita::verificaSiRutNoEx($dataVisita[0],$dataVisita);      //print_r($idVisitanew);      //die();      //var_dump($patente);      if($patente=="S/P"||$esta>0)      {      	$tipoReserva = "Vehicular";      	      	if($esta!=0)      	{      		if($idc!=null)      		{      			$yaAlV = controlVisita::getVisitaWithId($idvP);      			if($yaAlV!=null)      			{      				$idVisitanew = $yaAlV->getidVisista();      			}      			else      			{      				$idVisitanew = controlVisita::insertVisitaYretId($dataVisita,$idc);      			}	      			if($idVisitanew!=null && $idVisitanew>0)      			{      				$dataReserva = array($idc,null,$idVisitanew,$st,$et,$tipoReserva,0,$pisos,$oficina,$esta,"Reservada",null,$idVisitanew,$patente);      				controlReserva::insertaReserva($dataReserva);      			}      			       		}			       	}      }      else       {      	if($idc!=null)      	{      		$yaAlV = controlVisita::getVisitaWithId($idvP);      		//echo var_dump($dataVisita)." ".$idc.'<br>'.$yaAlV."         ";      			if($yaAlV!=null)      			{      				$idVisitanew = $yaAlV->getidVisista();      			}      			else      			{      				$idVisitanew = controlVisita::insertVisitaYretId($dataVisita,$idc);      			}	      			      		if($idVisitanew!=null && $idVisitanew>0)      		{      			$dataReserva = array($idc,null,$idVisitanew,$st,$et,$tipoReserva,0,$pisos,$oficina,$esta,"Reservada",null,$idVisitanew,0);      			controlReserva::insertaReserva($dataReserva);      		}      	      	}      	      }                        $ret['Msg'] = 'add success';      $ret['Data'] = rand();  return $ret;}function listCalendarByRange($sd, $ed, $cnt){  $ret = array();  $ret['events'] = array();  $ret["issort"] =true;  $ret["start"] = php2JsTime($sd);  $ret["end"] = php2JsTime($ed);  $ret['error'] = null;  $title = array('team meeting', 'remote meeting', 'project plan review', 'annual report', 'go to dinner');  $location = array('Lodan', 'Newswer', 'Belion', 'Moore', 'Bytelin');  for($i=0; $i<$cnt; $i++) {      $rsd = rand($sd, $ed);      $red = rand(3600, 10800);      if(rand(0,10) > 8){          $alld = 1;      }else{          $alld=0;      }      $ret['events'][] = array(        rand(10000, 22222),        $title[rand(0,4)],        php2JsTime($rsd),        php2JsTime($red),        rand(0,1),        $alld, //more than one day event        0,//Recurring event        rand(-1,13),        1, //editable        $location[rand(0,4)],         ''//$attends      );  }  return $ret;}function listCalendarByRangeTst($reser,$et,$ed){
	$ret = array();
	$ret['events'] = array();
	$ret["issort"] =true;
	$ret["start"] = php2JsTime($et);
	$ret["end"] = php2JsTime($ed);
	$ret['error'] = null;	$rsd = $et;	$visita = null;	if($reser!=null && count($reser)>0)	{			foreach ($reser as $reserva)			{				$visita = controlVisita::getVisitaWithId($reserva->getidVisita());				//print_r($visita);				$tipoReserva = $reserva->gettipoReserva();				$color = 1;				$estac = "";				if($tipoReserva=="Vehicular")				{					$color = 5;					$estac = " estacionamiento: ".$reserva->getestacionamientoAsignado();				}								$fechaE = new DateTime($reserva->getfechaEntrada());				$fechaS = new DateTime($reserva->getfechaSalida());
				//echo $fecha->format('d/m/y H:i')				$phpTimeI = js2PhpTime($fechaE->format('m/d/y H:i'));				$phpTimeS = js2PhpTime($fechaS->format('m/d/y H:i'));				//echo "nuestra ".php2JsTime($phpTimeI)."   ";				//echo "siste".php2JsTime($rsd);				$ret['events'][] = array(
						$reserva->getidReserva(),
						$visita->getnombre()." ".$visita->getapellido()." * "." Reserva: ".$tipoReserva.$estac,
						php2JsTime($phpTimeI),
						php2JsTime($phpTimeS),
						0,
						0, //more than one day event
						0,//Recurring event
						$color, //5 azul, 1 rojo
						1, //editable
						"S/N",
						''//$attends
				);				//die();			}	}		//print_r($ret);
	return $ret;
}function listCalendar($day, $type,$perUser,$idc){  //echo $perUser;  $phpTime = js2PhpTime($day);  $reserva = null;   //$nivel = $usuario->getPrivilegio();  //echo $phpTime . "+" . $type;  switch($type){  	    case "month":      $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime)+1, 1, date("Y", $phpTime));      $cnt = 50;      //echo "mes".$day;            if($perUser>5)      {      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et));      }      else      {      	      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et),$idc);      }            break;    case "week":      //suppose first day of a week is monday	  $monday  =  date("d", $phpTime) - date('N', $phpTime) + 1;      //echo date('N', $phpTime);      $st = mktime(0,0,0,date("m", $phpTime), $monday, date("Y", $phpTime));      $et = mktime(0,0,-1,date("m", $phpTime), $monday+7, date("Y", $phpTime));  	    	  if($perUser>5)      {      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et));      }      else      {      	      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et),$idc);      }      //$cnt = 2;      break;    case "day":      $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));      $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime)+1, date("Y", $phpTime));  	    	  if($perUser>5)      {      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et));      }      else      {      	      	$reserva = controlReserva::getReservasforDate(null,php2MySql($st),php2MySql($et),$idc);      }      //$cnt = 5;      //echo "dia".$day;      break;  }  //echo $st . "--" . $et;  return listCalendarByRangeTst($reserva,$st,$et);  //return listCalendarByRange($st, $et, $cnt);}function updateCalendar($id, $st, $et) //arrastrar y soltar en otros dias{	$ret = array();	$dataR = null;	$bandera = false;	$mensaje = null;  /*   * idCliente,idOperador,idVisita,fechaEntrada,fechaSalida,tipoReserva,tipoFrecuencia,piso,oficina,estacionamientoAsignado,estadoValidacion,momentoValidacion,codigoReserva,patenteVehiculo   * controlReserva::updateReservaGlobal($dataR,$idr)   *    */	//echo $id."_".$st."_".$et;	//die();	if($id!=null && $st!=null && $et!=null)	{		$dataR = array(null,null,null,$st,$et,null,null,null,null,null,null,null,null,null);		if(controlReserva::updateReservaGlobal($dataR,$id)>=0)		{			$mensaje = "Se actualizo el dia y la hora de la reserva exitosamente";			$bandera = true;		}		else 		{			$mensaje = "Intente esta operacion mas tarde";		}	}	else	{		$mensaje = "Intente esta operacion mas tarde";	}	        $ret['IsSuccess'] = $bandera;      $ret['Msg'] = $bandera;    return $ret;}function updateDetailedCalendar($idr,$idv, $idc, $st, $et, $nombre, $apellido, $mail, $pisos, $oficina, $patente, $esta){	  	  $ret = array();	  /* editaVisita(dato[])	   * 	   * UpdateVisita :   rut = ?,dv = ?,pasaporte = ?,nombre =?,apellido = ?, contacto = ?,telefono= ?,empresa = ?,rubro = ?,direccion = ? WHERE idVisita = ?	   * 	   * updateReservaGlobal($data,$idReserva)	   * 	   * update reserva: $dato[]	   * idCliente,idOperador,idVisita,fechaEntrada,fechaSalida,tipoReserva,tipoFrecuencia,piso,oficina,estacionamientoAsignado,estadoValidacion,momentoValidacion,codigoReserva,patenteVehiculo	   * 	   */	  //controlReserva::updateReservaGlobal($data,$idReserva);	  //echo $idv."_".$idc."_".$st."_".$et."_".$nombre."_".$apellido."_".$mail."_".$pisos."_".$oficina."_".$patente."_".$esta;	  $dataV = null;	  $dataR = null;	  $bandera = false;	  $tipoReserva = "Peatonal";	  $estadoValidaci√≥n= "Reservada";	  $tipoFrecuencia = 0;	  $mensaje = null;	 // die();	  if($idv!=null && $idc!=null && $st!=null && $et!=null)	  {	  	if($patente=="S/P")	  	{	  		$tipoReserva = "Vehicular";	  		if($esta!=0)	  		{			  	$dataV = array(null,null,null,$nombre,$apellido,$mail,null,null,null,null,$idv);			  	controlVisita::editaVisita($dataV);			  	//echo controlVisita::editaVisita($dataV);				$dataR = array($idc,null,$idv,$st,$et,$tipoReserva,$tipoFrecuencia,$pisos,$oficina,$esta,$estadoValidaci√≥n,null,$idv,$patente);			  	controlReserva::updateReservaGlobal($dataR,$idr);				$mensaje = "La reserva Vehicular se actualizo exitosamente";			  	$bandera = true;	  		}	  		else	  		{	  			//para ingresar una reserva vehicular es necesario seleccionar un estacionamiento	  			$mensaje = "Para reservar una visita vehicular debe seleccionar el estacionamiento";
	  			$bandera = false;	  		}	  	}	  	else 	  	{	  		$dataV = array(null,null,null,$nombre,$apellido,$mail,null,null,null,null,$idv);
	  		controlVisita::editaVisita($dataV);	  		//echo controlVisita::editaVisita($dataV);
	  		$dataR = array($idc,null,$idv,$st,$et,$tipoReserva,$tipoFrecuencia,$pisos,$oficina,$esta,$estadoValidaci√≥n,null,$idv,$patente);	  		controlReserva::updateReservaGlobal($dataR,$idr);	  		$mensaje = "La reserva peatonal se actualizo exitosamente";	  		$bandera = true;	  	} 		  }	  else 	  {	  	$mensaje = "Porfavor intente mas tarde";	  	$bandera = false;	  }	  //$reserva = controlReserva::updateReservaGlobal($id);        $ret['IsSuccess'] = $bandera;      $ret['Msg'] = $mensaje;                    return $ret;}function removeCalendar($id){  $ret = array();  //eliminarRegistro($idReserva) solo reserva esporadica  //eliminarFrecuenciaDias($idReserva,$tipoF=null,$tipoNow=null) Si es frecuente elimina los dias tambien asocidaso a esa visita  $bandera = false;  $mensaje = null;  if($id!=null)  {  	controlReserva::eliminarFrecuenciaDias($id);  	controlReserva::eliminarRegistro($id);  	$bandera= true;  	$mensaje = "La reserva se elimino correctamente";  	  }  else  {  	$mensaje = "Problemas con la operaci√≥n efectuada";  }      $ret['IsSuccess'] = $bandera;      $ret['Msg'] = $mensaje;  return $ret;}header('Content-type:text/javascript;charset=UTF-8');$method = $_GET["method"];switch ($method) {    case "add":        //$ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["Calenda<rTitle"], $_POST["IsAllDayEvent"]); //agregar al calendario        //print_r($_GET);        //print_r($_POST);        break;    case "list":    	
    	$ret = listCalendar($_POST["showdate"], $_POST["viewtype"],$usuario->getPrivilegio(),$usuario->getidCliente());        //echo $_POST["showdate"];        //die();        break;    case "update":    	    	//print_r($_POST);        $idr = $_POST["calendarId"];        $st =  $_POST["CalendarStartTime"];        $et =  $_POST["CalendarEndTime"];        $st = new DateTime($st);    	$et = new DateTime($et);    	    	$ret = updateCalendar($_POST["calendarId"], date_format($st, "Y-m-d H:i"), date_format($et, "Y-m-d H:i"));    	                        break;     case "remove":        $ret = removeCalendar( $_POST["calendarId"]);        //print_r($_POST);        //die();        break;    case "adddetails":    	    	    	$idr = isset($_GET["id"])?$_GET["id"]:null;        $idc = isset($_GET["idc"])?$_GET["idc"]:null;        $idv = isset($_GET["idv"])?$_GET["idv"]:null;        //print_r($_GET);        //echo $id."___".$idc;        //print_r($_POST);        //Timestamp:  2012-10-10 00:00:00                        $st = $_POST["stpartdate"] . " " . $_POST["stparttime"];        $et = $_POST["etpartdate"] . " " . $_POST["etparttime"];                $st = new DateTime($st);        $et = new DateTime($et);                if($idv)        {            $ret = updateDetailedCalendar($idr,$idv,$idc,date_format($st,"Y-m-d H:i"),date_format($et,"Y-m-d H:i"),$_POST["Nombre"],$_POST["Apellido"],$_POST["Mail"],$_POST["pisoss"],$_POST["oficinass"],$_POST["p"],$_POST["estacioReservaCalendar"]);        }        else        {            $idvP = isset($_POST["idvP"])?$_POST["idvP"]:null;            $ret = addDetailedCalendar($idc,date_format($st,"Y-m-d H:i"),date_format($et,"Y-m-d H:i"),$_POST["Nombre"],$_POST["Apellido"],$_POST["Mail"],$_POST["pisoss"],$_POST["oficinass"],$_POST["p"],$_POST["estacioReservaCalendar"],$idvP);        }                      /*         * Array(    [method] => adddetails    [id] => 132    [idc] => 43)Array(    [stpartdate] => 11/20/12    [stparttime] => 08:45    [etpartdate] => 11/23/12    [etparttime] => 16:17    [pisoss] => 0    [oficinass] => -1    [Subject] => Controles Control    [estacioReservaCalendar] => 0    [timezone] => -3)         *          */        break; }echo json_encode($ret); ?>